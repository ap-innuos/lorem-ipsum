<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Innuos</title>
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <!-- Cast Debug Logger -->
    <script src="https://www.gstatic.com/cast/sdk/libs/devtools/debug_layer/caf_receiver_logger.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"
        integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1a1a;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #loading,
        #error,
        .content {
            display: none;
        }

        #loading.active,
        #error.active,
        .content.active {
            display: flex;
        }

        #loading {
            font-size: 2em;
        }

        #error {
            font-size: 2em;
            color: red;
        }

        .content {
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 5vw;
        }

        #album-art {
            width: 50%;
            height: auto;
        }

        .info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            margin-left: 30px;
            max-width: 50%;
        }

        .info div {
            margin: 0.1em 0;
        }

        .song-title {
            font-size: 2.2rem;
            font-weight: 600;
        }

        .artist-name {
            font-size: 2.2rem;
            font-weight: 300;
        }

        .album-name {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .play-icon {
            margin-top: 60px;
            text-align: center;
        }

        .material-icons {
            font-size: 8vw;
            color: white;
            cursor: pointer;
        }

        .quality-and-source {
            display: flex;
            gap: 8px;
            flex-direction: row;
            align-items: center;
        }

        .bit-sample-rate {
            display: flex;
            gap: 2px;
            flex-direction: column;
        }

        .source-icon {
            color: white;
            border: 1px solid white;
            height: 11px;
            padding: 2px 7px;
            font-size: 0.7em;
            text-align: center;
            width: auto;
            margin-left: 7px;
            border-radius: 20px;
            margin: 0 !important;
            line-height: 11px;
        }

        .rate-text {
            font-size: 0.5em;
            line-height: 9px;
            margin: 0;
            color: white;
            text-align: left;
        }

        .source-img {
            width: 1.5em;
            height: 1.5em;
        }
    </style>
</head>

<body>
    <div id="loading" class="active">Loading...</div>
    <div id="error">Error: Unable to load song data</div>

    <div class="content">
        <img id="album-art" src="https://static.qobuz.com/images/covers/6a/gy/x95616fwfgy6a_600.jpg" alt="Album Art">
        <div class="info">
            <div class="song-title" id="song-title">
                <div>Can't Get Out Of This Mood</div>
            </div>
            <div class="artist-name" id="artist-name">
                <div>Samara Joy</div>
            </div>
            <div class="album-name" id="artist-name">
                <div>Samara Joy</div>
            </div>
            <div class="quality-and-source">
                <img id="source-img" class="source-img" src="" alt="Source Image">
                <div class="source-icon" id="source-icon">
                    <div>FLAC</div>
                </div>
                <div class="bit-sample-rate" id="artist-name">
                    <div class="rate-text" id="bitdepth-text">
                        <div>16 bit</div>
                    </div>
                    <div class="rate-text" id="bitrate-text">
                        <div>44.1 kHz</div>
                    </div>
                </div>
            </div>
        </div>
        <!--         <div class="play-icon" id="icon">
            <i class="material-icons">play_circle_outline</i>
        </div> -->


    </div>

    <script>
        const loadingScreen = document.getElementById('loading');
        const errorScreen = document.getElementById('error');
        const contentScreen = document.querySelector('.content');



        function showError() {
            loadingScreen.classList.remove('active');
            contentScreen.classList.remove('active');
            errorScreen.classList.add('active');
        }

        function selectSourceImage(source) {
            switch (source.toUpperCase()) {
                case 'TIDAL': return './images/tidal.png'; break;
                case 'TCONNECT': return './images/tidal_connect.png'; break;
                case 'DEEZER': return './images/deezer.png'; break;
                case 'AMAZON': return './images/amazon.png'; break;
                case 'QOBUZ': return './images/qobuz.png'; break;
                case 'IDAGIO': return './images/idagio.png'; break;
                case 'ROON': return './images/roon.png'; break;
                case 'HIGHRESAUDIO': return './images/highresaudio.jpg'; break;
                case 'NAS': return './images/dns.png'; break;
                case 'USB': return './images/usb.png'; break;
                case 'RADIO': return './images/radio.png'; break;
                case 'PODCASTS': return './images/podcasts.png'; break;
                case 'AIRPLAY': return './images/apple.png'; break;
                default: return './images/library.png';
            }
        }

        // Initialize Cast Receiver Framework

        const nameSpace = "urn:x-cast:innuos.innuossense.com"
        const context = cast.framework.CastReceiverContext.getInstance();
        const testDisplay = document.createElement('p');
        console.log("Here", context)
        //testDisplay.textContent = 'teste: ' + JSON.stringify(context);
        //document.body.appendChild(testDisplay);
/*

        const ip = 'http://192.168.1.200:3000/'
        const playerSocket = io(ip);

        playerSocket.on("connect", () => {
            console.log('-> Player connected');
        });

        playerSocket.on("player_status", newPlayerState => {
            console.log("Received player status:", newPlayerState);
            const playerObject = newPlayerState.player_loop['4c:38:d5:15:52:7e'];

            if (playerObject && playerObject.track) {
                const title = playerObject.track.title;
                const joinedNames = playerObject.track.artist.map(obj => obj?.name).join(', ') || "Unknown Artist";

                const cover = playerObject.track.cover;
                const mode = playerObject.mode;


                const format = playerObject.track.format.toLowerCase();
                const bitrate = playerObject.track.bitrate;
                const bitdepth = playerObject.track.bitdepth;
                const sample_rate = playerObject.track.sample_rate > 1000 ? playerObject.track.sample_rate / 1000 : playerObject.track.sample_rate
                const source = playerObject.track.source;

                if (title && joinedNames && cover) {
                    document.getElementById("song-title").querySelector("div").textContent = title;
                    document.getElementById("artist-name").querySelector("div").textContent = joinedNames;
                    document.getElementById("album-art").src = cover;
                    /*if (mode == 'stop') {
                        document.getElementById("icon").querySelector("i").textContent = 'pause_circle_outline';
                    }
                    if (format == 'mp3') {
                        document.getElementById("bitdepth-text").querySelector("div").textContent = bitrate + ' kbps CBR';
                        document.getElementById("bitrate-text").querySelector("div").textContent = '';
                    } else if (['flac', 'wav'].includes(format)) {
                        document.getElementById("bitdepth-text").querySelector("div").textContent = (bitdepth || 16) + ' bit';
                        document.getElementById("bitrate-text").querySelector("div").textContent = sample_rate + ' kHz';
                    }

                    const srcImg = selectSourceImage(source);
                    document.getElementById("source-img").src = srcImg;

                    loadingScreen.classList.remove('active');
                    errorScreen.classList.remove('active');
                    contentScreen.classList.add('active');

                } else {
                    showError();
                }
            } else {
                showError();
            }
        });
*/

        const playerManager = context.getPlayerManager();

        // Optionally set up event handlers for when media loads
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (loadRequestData) => {
                console.log('Load request received:', loadRequestData);
                const messageDisplayteste = document.createElement('p');
                document.body.appendChild(messageDisplayteste);

                const ip = loadRequestData.media.customData.playerSocketURL
                const playerSocket = io(ip);

                playerSocket.on("connect", () => {
                    console.log('-> Player connected');
                });

                playerSocket.on("player_status", newPlayerState => {
                    console.log("Received player status:", newPlayerState);
                    const playerObject = newPlayerState.player_loop['4c:38:d5:15:52:7e'];

                    if (playerObject && playerObject.track) {
                        const title = playerObject.track.title;
                        const joinedNames = playerObject.track.artist.map(obj => obj?.name).join(', ') || "Unknown Artist";
                        const cover = playerObject.track.cover;
                        const mode = playerObject.mode;

                        const format = playerObject.track.format.toLowerCase();
                        const bitrate = playerObject.track.bitrate;
                        const bitdepth = playerObject.track.bitdepth;
                        const sample_rate = playerObject.track.sample_rate > 1000 ? playerObject.track.sample_rate / 1000 : playerObject.track.sample_rate
                        const source = playerObject.track.source;


                        if (title && joinedNames && cover) {
                            document.getElementById("song-title").querySelector("div").textContent = title;
                            document.getElementById("artist-name").querySelector("div").textContent = joinedNames;
                            document.getElementById("album-art").src = cover;
                            /*if (mode == 'stop') {
                                document.getElementById("icon").querySelector("i").textContent = 'pause_circle_outline';
                            }*/
                            if (format == 'mp3') {
                                document.getElementById("bitdepth-text").querySelector("div").textContent = bitrate + ' kbps CBR';
                                document.getElementById("bitrate-text").querySelector("div").textContent = '';
                            } else if (['flac', 'wav'].includes(format)) {
                                document.getElementById("bitdepth-text").querySelector("div").textContent = (bitdepth || 16) + ' bit';
                                document.getElementById("bitrate-text").querySelector("div").textContent = sample_rate + ' kHz';
                            }

                            const srcImg = selectSourceImage(source);
                            document.getElementById("source-img").src = srcImg;

                            loadingScreen.classList.remove('active');
                            errorScreen.classList.remove('active');
                            contentScreen.classList.add('active');
                        } else {
                            showError();
                        }
                    } else {
                        showError();
                    }
                });

                // Return the data as-is or modified for further handling
                return loadRequestData;
            }
        );


        function broadcastTime() {
            setInterval(() => {
                const currentTime = new Date().toLocaleTimeString();

                // Send the current time to all connected senders
                context.getSenders().forEach((sender) => {
                    context.sendMessage(namespace, {
                        message: `Current time is: ${currentTime}`
                    }, sender.id);
                });
            }, 1000); // Run every second
        }
        broadcastTime()

        // Start the receiver
        context.start();
    </script>
</body>

</html>